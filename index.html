<html>
    <head>
        <title>Food Donation</title>
        <style>
            #app{
                margin-top: 5%;
                margin-left: 1%;
            }
            .profile{
                line-height: 20px;
            }
            .donate-form{
                line-height: 20px;
                width: 25%;
            }
            .profileEdit{
                margin-right: 50%;
                margin-left: 10px;
            }
            .textBox{
                width: 40%;
            }
        </style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
        <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    </head>
    <body>
        <div id="app">
            <div v-if="page === 'login'">
                <b-field>
                    <b-input type="number" @keyup.native.enter="login" v-model="phoneNumber" style="width: 20%;" placeholder="Enter your phone number"></b-input>
                </b-field>    
                <b-button type="is-primary" outlined @click="login" class="p-button-text">Login</b-button>
            </div>

            <div v-else-if="page === 'otp'">
                <b-field>
                    <b-input type="number" @keyup.native.enter="otpVerify" v-model="otp" placeholder="Enter OTP" style="width: 20%;"></b-input>
                </b-field>
                <b-button type="is-primary " outlined @click="otpVerify">Verify</b-button>   
                <b-button type="is-primary " outlined @click="page = 'login'">Back</b-button>
            </div>

            <div v-else-if="page === 'home'" class="header">
                <h1>{{header}}</h1>
                <b-button type="is-primary " outlined @click="page = 'profile'" class="p-button-text">Profile</b-button>
                <b-button type="is-primary " outlined @click="signOut" class="p-button-text">Sign out</b-button><br><br>
                <b-button type="is-primary " rounded outlined @click="showItem = !showItem" class="btn btn-primary">{{showItem ? "Cancel" :"Donate"}}</b-button>

                <div v-if="showItem" class="donate-form">
                    <div class="card">
                        <div class="card-content">
                            <div class="content">        
                                Name: <b-input type="text" v-model="form.name" ></b-input><br>
                                Phone Number: <b-input type="number" v-model="form.phoneNumber" ></b-input><br>
                                Address Line 1: <b-input type="text" v-model="form.addLine1" ></b-input><br>
                                Address Line 2: <b-input type="text" v-model="form.addLine2" ></b-input><br>
                                Served For: <b-input type="number" v-model="form.servedFor" ></b-input><br>
                                <b-checkbox v-model="form.foodTypeVeg">Veg</b-checkbox>
                                <b-checkbox v-model="form.foodTypeNonVeg">Non Veg</b-checkbox><br><br>
                                <b-button type="is-primary " outlined @click="postNow" class="p-button-text">Submit</b-button>
                            </div>
                        </div>
                    </div>
                </div>            
            </div>

            <div v-else-if="page === 'profile'" class="profile">
                <label>Phone Number: {{phoneNumber}}</label><br>
                <label>Name: {{profile.name}}</label><br>
                <label>Email: {{profile.email}}</label><br><br>
                <b-button type="is-primary " outlined @click="edit" class="p-button-text">Edit</b-button>
                <b-button type="is-primary " outlined @click="page = 'home'" class="p-button-text">Back</b-button>
            </div>

            <div v-else-if="page === 'profile-edit'" class="profileEdit">
                <b-field label="Phone Number: " horizontal> {{phoneNumber}}</b-field><br>
                <b-field label="Name: " horizontal><b-input type="text" class="textBox" v-model="profile.name"></b-input></b-field><br>
                <b-field label="Email: " horizontal><b-input type="Email" class="textBox" v-model="profile.email"></b-input></b-field><br>
                <b-button type="is-primary " outlined @click="save" class="p-button-text">Save</b-button>
                <b-button type="is-primary " outlined @click="cancel" class="p-button-text">Cancel</b-button>
            </div>

            <div v-else-if="page === 'admin'" >
                <h1>Admin Page</h1>
                <b-button type="is-primary " outlined @click="signOut" class="p-button-text">Sign out</b-button><br><br>
                <b-button type="is-primary " outlined @click="showDonation" class="p-button-text">Show Donations</b-button>
                <b-button type="is-primary " outlined @click="showUser" class="p-button-text">User Details</b-button>
                <b-table :data="userDetails" 
                :columns="userColumns" 
                :sort-icon="sortIcon" 
                :sort-icon-size="sortIconSize" @cellclick="handleCellClick" v-if="showUserTable">
                </b-table>
                <b-table :data="donationDetails" :columns="donationColumns" :sort-icon="sortIcon" :sort-icon-size="sortIconSize" v-if="showDonationTable"></b-table>
                <b-modal
                v-model="showModal"
                has-modal-card
                trap-focus
                :destroy-on-hide="false"
                aria-role="dialog"
                aria-label="Example Modal"
                close-button-aria-label="Close"
                aria-modal></b-modal>
            </div>
        </div>

        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
        <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
        <script src="https://kit.fontawesome.com/bd90a56b74.js" crossorigin="anonymous"></script>
        <script>
            new Vue({
                el: '#app',
                data: {
                    val: '',
                    page: 'login',
                    header: "Food Donation",
                    form:{    
                        name: '' ,
                        phoneNumber: '',
                        addLine1: '',
                        addLine2: '',
                        servedFor: 0,
                        foodTypeVeg: false,
                        foodTypeNonVeg: false,
                        foodtype: '',
                        dateTime: '',
                    },
                    profile:{
                        name: '',
                        email: '',
                    },
                    donationDetails: [],
                    donations: [],
                    userDetails: [],
                    users: [],
                    userStringified: [],
                    phoneNumber: '',
                    otp: '',
                    showItem: false,
                    showDonationTable: false,
                    showUserTable: false,
                    showModal: false,
                    formClick: false,
                    instance: null,
                    sortIcon: 'arrow-up',
                    sortIconSize: 'is-small',
                    donationColumns: [
                        {
                        field: "name",
                        label: "Name",
                        sortable: true,
                        },
                        {
                        field: "phoneNumber",
                        label: "Phone Number",
                        sortable: true,
                        },
                        {
                        field: "addLine1",
                        label: "Address Line 1",
                        sortable: true,
                        },
                        {
                        field: "addLine2",
                        label: "Address Line 2",
                        sortable: true,
                        },
                        {
                        field: "servedFor",
                        label: "Served For",
                        sortable: true,
                        },
                        {
                        field: "foodType",
                        label: "Food Type",
                        sortable: true,
                        },
                        {
                        field: "dateTime",
                        label: "Date/Time",
                        sortable: true,
                        }
                    ],
                    userColumns: [
                        {
                            field: "name",
                            label: "Name",
                            sortable: true,
                            width: '30%',
                        },
                        {
                            field: "phoneNumber",
                            label: "Phone Number",
                            sortable: true,
                            width: '20%',
                        },
                        {
                            field: "email",
                            label: "Email",
                            sortable: true,
                            width: '40%',
                        },
                        {
                            field: 'edit',
                            width: '5%',
                        },
                        {
                            field: 'delete',
                            width: '5%',
                        }
                    ],
                },
                mounted: function(){
                    console.log('mounted')
                    this.instance = axios.create({
                        // baseURL: 'https://astra.free.beeceptor.com',
                        baseURL: 'http://127.0.0.1:5000',
                        timeout: 30000,
                        headers: {
                            'Content-type': 'application/json',
                        }
                    });
                    
                    this.profile.name = localStorage.getItem("name")
                    this.phoneNumber = localStorage.getItem("phoneNumber")
                    this.profile.email = localStorage.getItem("email")
                    console.log(this.phoneNumber)
                    if(this.phoneNumber === '12345'){
                        this.page = 'admin'
                    }
                    else if(this.phoneNumber === '' || this.phoneNumber === null){
                        this.page = 'login'
                    }
                    else if(this.phoneNumber !== ''){
                        this.page = 'home'
                    }
                },
                computed: {
                    foodType(){
                        if(this.form.foodTypeVeg === true && this.form.foodTypeNonVeg === true){
                            return "Both"
                        }
                        else if(this.form.foodTypeNonVeg === true){
                            return "Non Veg"
                        }
                        else if(this.form.foodTypeVeg === true){
                            return "Veg"
                        }
                    }
                },
                methods: {  
                    postNow(){
                        this.formClick = !this.formClick
                        console.log(axios) 

                        this.form.dateTime = new Date().toLocaleString();
                        console.log(this.form.dateTime)

                        this.instance.post('/add_donation', {
                            name: this.form.name,
                            phoneNumber: this.form.phoneNumber,
                            addLine1: this.form.addLine1,
                            addLine2: this.form.addLine2,
                            servedFor: this.form.servedFor,
                            foodType: this.foodType,
                        })

                        this.donations.push({
                            name: this.form.name,
                            phoneNumber: this.form.phoneNumber,
                            addLine1: this.form.addLine1,
                            addLine2: this.form.addLine2,
                            servedFor: this.form.servedFor,
                            foodType: this.foodType,
                            dateTime: this.form.dateTime,
                        })
                        localStorage.setItem("donations", JSON.stringify(this.donations))

                        this.$buefy.dialog.alert({
                            message: 'Form Submitted successfully!',
                            type: 'is-primary',
                            confirmText: 'You\'ve made someone happy : )',
                        })
                    },
                    login(){
                        if(this.phoneNumber === ''){
                            this.$buefy.dialog.alert({
                                message: 'Enter a phone number!',
                                type: 'is-danger',
                                hasIcon: true,
                                icon: 'times-circle',
                                iconPack: 'fa',
                                ariaRole: 'alertdialog',
                                ariaModal: true,
                            })
                        }
                        else{
                            this.page = 'otp'
                            this.form.phoneNumber = this.phoneNumber
                            
                            console.log(this.form)
                        }
                    },
                    otpVerify(){
                        if(this.otp === '123'){
                            if(this.phoneNumber === '12345'){
                                this.page = 'admin'   
                                this.showDonationTable = false
                                this.showUserTable = false
                            }
                            else{
                                this.page = 'home'
                            }
                            localStorage.setItem("phoneNumber", this.phoneNumber)
                        }
                        else{
                            this.$buefy.dialog.alert({
                                message: 'OTP Incorrect!',
                                type: 'is-danger',
                                hasIcon: true,
                                icon: 'times-circle',
                                iconPack: 'fa',
                                ariaRole: 'alertdialog',
                                ariaModal: true,
                            })
                        }   
                    },
                    signOut(){
                        localStorage.removeItem("phoneNumber")
                        this.phoneNumber = ''
                        this.page = 'login'   
                        this.form.name = '' 
                        this.form.addLine1 = ''
                        this.form.addLine2 = ''
                        this.form.servedFor = 0
                        this.form.foodTypeVeg = false
                        this.form.foodTypeNonVeg = false
                        this.form.foodtype = ''
                        this.form.dateTime = ''
                        this.otp = ''
                        this.profile.name = ''
                        this.profile.email = ''
                    },
                    edit(){
                        this.page = 'profile-edit'
                    },
                    save(){
                        this.page = 'profile'
                        this.userDetails.push({
                            name: this.profile.name,
                            email: this.profile.email,
                            phoneNumber: this.phoneNumber,
                        })
                        this.instance.post('/add_user', {
                            name: this.profile.name,
                            email: this.profile.email,
                            phoneNumber: this.phoneNumber,
                        })

                        localStorage.setItem("userDetails", JSON.stringify(this.userDetails))
                        console.log(this.userDetails)
                    },
                    cancel(){
                        this.profile.name = ''
                        this.profile.email = ''
                        this.page = 'profile'
                    },
                    showDonation(){
                        this.showDonationTable = !this.showDonationTable
                        this.showUserTable = false
                        // this.donationDetails = JSON.parse(localStorage.getItem("donations"))
                        this.instance.get('/donations')
                        .then((response) => {
                            this.donationDetails = response.data.donations
                            console.log(response)
                        })
                    },
                    showUser(){
                        this.showUserTable = !this.showUserTable
                        this.showDonationTable = false
                        // this.userDetails = JSON.parse(localStorage.getItem("userDetails"))
                        this.instance.get('/users')
                        .then((response) => {
                            console.log(response)
                            this.userDetails = response.data.users
                            for(var i = 0; i < this.userDetails.length; i++){
                                this.userDetails[i]['edit'] = '<i class="fa-solid fa-pencil"></i>';
                                this.userDetails[i]['delete'] = '<i class="fa-solid fa-trash"></i>';
                                console.log(this.userDetails[i])
                            }
                        })   
                    },
                    deleteUser(rowIndex){
                        this.$buefy.toast.open('Account deleted!')
                        this.userDetails.splice(rowIndex, 1)
                        // console.log(this.userDetails)
                        localStorage.setItem("userDetails", JSON.stringify(this.userDetails))
                    },
                    handleCellClick(row, col, rowIndex, colIndex){
                        console.log("handleCellClick >")
                        console.log(row)
                        console.log(col)
                        console.log(rowIndex)
                        console.log(colIndex)
                        if(colIndex === 4){
                            // console.log('delete')
                            this.$buefy.dialog.confirm({
                                title: 'Delete account',
                                message: 'Are you sure you want to <b>delete</b> this account? This action cannot be undone.',
                                confirmText: 'Delete Account',
                                type: 'is-danger',
                                hasIcon: true,
                                onConfirm: () => this.deleteUser(rowIndex)
                            })
                        }
                        if(colIndex === 3){
                            this.showModal = true
                            console.log('edit')
                        }
                    }
                }
            })
        </script>
    </body>
</html>